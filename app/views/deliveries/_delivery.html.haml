= link_to delivery.address.text, to_address_path(delivery.address)
%span{class: label_class(delivery.status)}
  = link_to status_name(delivery.status), "#log-#{delivery.id}", "data-toggle" => "collapse"
- if delivery.opened?
  %span.label.label-success
    = link_to "Opened", "#open-#{delivery.id}", "data-toggle" => "collapse"
- if delivery.clicked?
  %span.label.label-success
    = link_to "Clicked", "#clicked-#{delivery.id}", "data-toggle" => "collapse"
      
- unless delivery.postfix_log_lines.empty?
  .collapse{id: "log-#{delivery.id}"}
    %table.table.table-condensed
      %thead
        %tr
          %th Time
          %th DSN
          %th Status
      %tbody
        - delivery.postfix_log_lines.each do |line|
          %tr
            %td
              = time_ago_in_words(line.time)
              ago
            %td= line.dsn
            %td.status= line.extended_status
- if delivery.opened?
  .collapse{id: "open-#{delivery.id}"}
    %table.table.table-condensed
      %thead
        %tr
          %th Time
          %th User agent
          %th Referer
          %th IP
          -#
            -# TODO: Re-enable all the user-agent stuff after we've worked out how to handle the issues when there are errors downloading the data file
            %th Client
            %th OS
      %tbody
        - delivery.open_events.each do |event|
          %tr
            %td
              = time_ago_in_words(event.created_at)
              ago
            %td= event.user_agent
            %td= event.referer
            %td= event.ip
            -#
              %td
                = link_to event.ua_family, event.ua_url
              %td
                = link_to event.os_family, event.os_url
- if delivery.clicked?
  .collapse{id: "clicked-#{delivery.id}"}
    %table.table.table-condensed
      %thead
        %tr
          %th Time
          %th Link
          %th User agent
          %th Referer
          %th IP
      %tbody
        - delivery.link_events.each do |event|
          %tr
            %td
              = time_ago_in_words(event.created_at)
              ago
            %td= link_to event.url          
            %td= event.user_agent
            %td= event.referer
            %td= event.ip
